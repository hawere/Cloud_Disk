<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>流程分析</title>
    <link rel="stylesheet" href="css/flow.css" media="screen" title="no title">
  </head>
  <body>
      <div>
        <h1 class="title_h">线程设计:</h1>
        <p>
          &nbsp;&nbsp;&nbsp;&nbsp;此服务器软件为了维护系统的稳定性以及及时处理用户的事件请求任务,使用多线程并发执行的模式设计.
          他总共包括一个主线程,一个用户清理线程,一个用户事件请求中转线程,和一个由若用户执行用户请求事件构成的线程池.
        </p>
        <p>
          <span class="title_p">主线程:</span>
        </p>
        <p class="context_class">
          主要负责服务器的启动初始化工作,其中包括: 对进入守护进程模式, 与mysql的链接交互, 与日志文件的交互, 用户主目录的检测.
          监听套接字的初始化,用户信息链的初始化,  epoll监听池的初始化,信号处理的初始化以及线程的初始化.
        </p>

        <p class="context_class">
          初始化完成后, 主线程主要负责监听用户到达的事件,并将事件交付给中转线程做进一步处理(用户退出事件将由主线程来处理),同时,主线程还要时刻监听中转线程产生的事件,
          以了解中转线程是否正常.
        </p>

        <p class="context_class">
          最后主线程还要注意终止服务器信号的处理,当捕获到终止服务器信号时, 主进程会妥善处理服务器关闭事件.
        </p>

        <p>
          <span class="title_p">用户清理线程:</span>
        </p>
        <p class="context_class">
          用户清理线程主要负责对长时间无反应的用户的清理工作,他的主要操作对象是用户信息链.
        </p>
        <p class="context_class">
          清理线程每隔 3 秒钟将对用户信息链做一次全程遍历, 遍历时他将对用户信息连进行加锁操作,防止链表结构发生更改.他在这个时候对每隔用户信息节点生存期进行检测.
          当检测到生存期为零时, 他将对用户执行下线操作, 并将其从监听池中移除, 但是这时候并不会对此节点的内存空间进行释放, 他将在之后遍历时对此节点进行释放,
          详情请查看<a href="user_message.html" class="line_class_link"><span class="class_key">用户信息维护篇</span></a>
        </p>

        <p>
          <span class="title_p">用户请求中转线程:</span>
        </p>
        <p class="context_class">
          用户请求中转线程主要负责用户事件的处理前准备,他主要维护用户请求处理线程池的运行状态, 在运行过程中,
          他将时刻保持与主线程和事件处理线程池的交互, 以时刻了解线程的状况,保持系统运行的稳定性.
        </p>
        <p class="context_class">
          中转线程与主线程交互时, 它主要是接受主线程传递来的用户请求, 然后判断线程池中是否有空闲线程,如果有则将用户的请求传递给线程池中的某个空闲线程.
          否则将向用户返回服务器忙状态.在将用户的事件递交给空闲线程前, 他首先将用户的通信接口从监听池中移除(防止在事件处理过程中频繁触发用户请求事件),
          而且,要将用户的生存期打标记, 防止在用户事件过程中用户连接被清理线程关闭.完成这些后, 他才将用户请求发给事件处理线程池中的空闲线程.
        </p>
        <p class="context_class">
          中转线程与事件处理线程池交互时,它主要负责接受用户事件处理完成后, 将用户重新放入监听, 在此之前他将首先判断用户事件处理过程中是否已经关闭,
          如果关闭, 他将删除用户信息节点,关闭用户的链接, 如果用户正常完成提交, 他将重置用户的生存期, 并将用户重新放入监听池中监听.
          如果线程池中的某个线程在处理过程中发生了不可挽回错误导致线程被关闭, 中转线程此时将重新启用一个线程加入线程池.
        </p>
        <p class="context_class">
          如果中转线程发生了不可挽回的错误,导致线程关闭, 此错误暂不可修复, 系统将退出.
        </p>
        <p>
          <span class="title_p">用户请求处理线程池:</span>
        </p>
        <p class="context_class">
          用户处理线程池是用户请求的主要处理中心, 为了提高事件处理效率, 这里使用了30个线程构成的线程池来并发等待用户的请求事件, 在处理用户的事件之前.
          他将首先判断用户的请求类型,将不同的请求对应于不同的方法, 如果在用户处理过程中用户发生了请求错误或退出事件, 处理线程将按照用户的不同情况向中转线程发送不同的,
          回应状态.
        </p>
      </div>
  </body>
</html>
